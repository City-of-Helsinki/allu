- name: Change database user {{ database_name }}'s password and user rights
  postgresql_user:
    login_host=localhost
    name={{ database_user }}
    password={{ database_password }}
    state=present
    role_attr_flags=NOCREATEDB,NOSUPERUSER,LOGIN
    login_password={{ database_password_postgres }}
  become: yes
  become_user: postgres

- name: Create database reporting user {{ database_reporting_user }}
  postgresql_user:
    login_host=localhost
    name={{ database_reporting_user }}
    password={{ database_reporting_user_password }}
    state=present
    login_password={{ database_password_postgres }}
  become: yes
  become_user: postgres

- name: Create database user {{ database_geo_user }}
  postgresql_user:
    login_host=localhost
    name={{ database_geo_user }}
    password={{ kami_hki_password }}
    state=present
    login_password={{ database_password_postgres }}
  become: yes
  become_user: postgres

- name: drop all public access rights to {{ database_name }} database
  postgresql_privs:
    login_host=localhost
    database={{ database_name }}
    state=absent
    roles=PUBLIC
    privs=ALL
    type=database
    login_password={{ database_password_postgres }}
  become: yes
  become_user: postgres

- name: add all access rights to {{ database_name }} database for {{ database_user }} user
  postgresql_privs:
    host=localhost
    database={{ database_name }}
    roles={{ database_user }}
    state=present
    privs=ALL
    type=database
    grant_option=yes
    login_password={{ database_password_postgres }}
  become: yes
  become_user: postgres

- name: add CONNECT to SELECT rights to {{ database_name }} database for {{ database_geo_user }} user
  postgresql_privs:
    host: localhost
    database: "{{ database_name }}"
    roles: "{{ database_geo_user }}"
    state: present
    privs: SELECT,CONNECT
    objs: ALL_IN_SCHEMA
    login_password: "{{ database_password_postgres }}"
  become: yes
  become_user: postgres

- name: Grant connect to {{ database_name }} for user {{ database_reporting_user }}
  postgresql_privs:
    host=localhost
    database={{ database_name }}
    roles={{ database_reporting_user }}
    state=present
    privs=CONNECT
    type=database
    login_password={{ database_password_postgres }}
  become: yes
  become_user: postgres
