
- name: install pip for Python dependency management
  apt: name=python-pip state=present

- name: install docker-py dependency for managing Docker with Ansible
  pip: name=docker-py

- name: check does Docker daemon already exist
  stat:
    path: /var/lib/docker
  register: dockerPresent

- name: remove existing docker containers, if executed in test enviroment
  shell: docker rm -f $(docker ps -qa --no-trunc)
  when: "dockerPresent.stat.exists and ('test' in group_names or 'staging' in group_names)"
  ignore_errors: yes

- name: remove existing docker images, if executed in test enviroment
  shell: docker rmi $(docker images -a -q --no-trunc)
  when: "dockerPresent.stat.exists and ('test' in group_names or 'staging' in group_names)"
  ignore_errors: yes

- name: shut down Docker, if it's installed. Start-up is done by roles that need Docker
  service: name=docker state=stopped
  when: dockerPresent.stat.exists

- name: copy Docker deb-package to target host
  copy: src=docker-ce_18.06.3_ce_3-0_ubuntu_amd64.deb dest=/tmp/docker.deb

# Docker deb packages are available at https://download.docker.com/linux/ubuntu/dists/xenial/pool/stable/amd64/
- name: Install Docker from deb package
  apt:
    deb: /tmp/docker.deb
