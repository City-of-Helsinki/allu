
- name: Build database Docker image. Uses random numbers to force Docker to build certain parts of image every time
  local_action:
    module: docker_image
    path: "{{ role_path }}/files/reporting_database_docker"
    name: allu_reporting_database
    force: true
    buildargs:
      CACHEBUST: "{{ 9999999 |random }}"
      POSTGRES_PWD: "{{ database_password_allu_reporting_postgres }}"

- name: remove existing docker image to avoid Ansible task caching
  local_action: file path=/tmp/allu_reporting_database.tar state=absent

- name: remove existing zipped docker
  local_action: file path=/tmp/allu_reporting_database.tar.gz state=absent

# This task requires docker-py to be installed on the local host. Also the user who's executing Ansible has to belong to docker group to be
# able to use docker without super user rights
- name: save local Docker image as file on local host
  local_action: docker_image
                name=allu_reporting_database
                archive_path=/tmp/allu_reporting_database.tar
                state=present

- name: gzip Docker image on local host
  local_action: command pigz /tmp/allu_reporting_database.tar

- name: copy Docker image to target host
  copy: src=/tmp/allu_reporting_database.tar.gz dest=/tmp
            owner=allu
            group=allu
            mode="u=rwx,g=rx,o=rx"

- name: extract tar from Docker gzipped image
  command: gunzip -f /tmp/allu_reporting_database.tar.gz

- name: start Docker services on remote host
  service: name=docker state=started
  become: yes

- name: stop and remove existing container from Docker
  docker_container:
    name: allu_reporting_database_container
    state: absent
  become: yes

- name: remove existing container from Docker
  docker_image:
    name=allu_reporting_database
    state=absent
    force=true
  become: yes

- name: add container to Docker
  docker_image:
    name=allu_reporting_database
    state=present
    load_path=/tmp/allu_reporting_database.tar
  become: yes

- name: start container
  docker_container:
    name: allu_reporting_database_container
    image: allu_reporting_database
    restart_policy: always
    volumes:
      - /srv/data/allu/reporting_database/data:/var/lib/postgresql/data:rw
    published_ports:
      - "5433:5432"
  become: yes

- name: remove Docker image tar file
  file: path=/tmp/allu_reporting_database.tar state=absent

- name: wait for Postgresql to initialize
  command: psql --host localhost -p 5433 -l -U postgres
  register: result
  until: result.rc != 2
  retries: 30
  delay: 1
  become: yes
  become_user: postgres
